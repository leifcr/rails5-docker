#!/bin/bash

set -e

function migrate_database() {
  set +e
  echo
  echo "== Migrating database"
  echo
  pushd $APP_HOME
  bundle exec rails db:migrate

  if [[ $? != 0 ]]; then
    echo
    echo "== Failed to migrate. Running setup first."
    echo
    set -e
    bundle exec rails db:setup && bundle exec rails db:migrate
  fi
  popd
}

# Migrate or setup db
migrate_database

exec /sbin/my_init
