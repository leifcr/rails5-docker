#!/bin/bash

set -e

function migrate_database() {
  set +e
  echo
  echo "== Migrating database"
  echo
  pushd $APP_HOME
  sudo -E setuser app bundle exec rails db:migrate

  if [[ $? != 0 ]]; then
    echo
    echo "== Failed to migrate. Running setup first."
    echo
    set -e
    sudo -E setuser app bundle exec rails db:setup && bundle exec rails db:migrate
  fi
  popd
}

# Migrate or setup db
migrate_database

exec sudo -E -H /sbin/my_init
# exec /sbin/preinit
